function say(a,b){"use strict";console.log('"'+a+'"'),meSpeak.speak(String(a),{pitch:40,speed:170,wordgap:1}),b&&b()}function pos2arg(a,b){"use strict";return a>0&&b>=0?Math.atan(b/a):0>a&&b>0?Math.PI-Math.atan(b/-a):0>a&&0>=b?Math.PI+Math.atan(-b/-a):a>0&&0>b?2*Math.PI-Math.atan(-b/a):0===a&&b>0?.5*Math.PI:0===a&&0>b?1.5*Math.PI:0/0}function enumerateObjects(a,b,c){"use strict";var d,e,f,g,h;for(b||(b={x:0,y:0}),c||(c={x:0,y:1}),e=[],d=0;d<a.length;++d)f=a[d].x-b.x,g=a[d].y-b.y,e.push([a[d],pos2arg(f,g)]);for(h=pos2arg(c.x-b.x,c.y-b.y),d=0;d<e.length;++d)e[d][1]=(e[d][1]-h+3*Math.PI)%(2*Math.PI);for(e.sort(function(a,b){return a[1]-b[1]}),d=0;d<e.length;++d)e[d][0].id=d+1}function getPlayer(a){"use strict";var b;for(b=0;b<players.length;++b)if(players[b].id===a)return players[b]}function checkSequence(){"use strict";var a;for(a=0;a<Math.min(storedSequence.length,currentSequence.length);++a)if(storedSequence[a]!==currentSequence[a])return!1;return!0}function unfreez(){"use strict";freeze=FREEZE_STATES.NONE}function Finger(){"use strict";var a=this;a.id=0,a.x=0,a.y=0,a.rotation=0,a.active=!1}function Player(){"use strict";function a(){var a,c;for(c={x:0,y:0},a=0;a<b.fingers.length;++a)c.x+=b.fingers[a].x/b.fingers.length,c.y+=b.fingers[a].y/b.fingers.length;enumerateObjects(b.fingers,b,c)}var b=this;b.id=0,b.x=0,b.y=0,b.size=50,b.fingers=[],b.leapFingerMap={},b.enumerateFingers=a}function Pulse(a,b){"use strict";var c=this;c.x=a,c.y=b,c.phase=0}function render(){"use strict";var a,b,c,d,e,f;for(f=Math.min(canvas.width,canvas.height)/400,ctx.setTransform(1,0,0,1,0,0),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.scale(f,f),ctx.translate(200+(canvas.width/f-400)/2,200+(canvas.height/f-400)/2),ctx.textAlign="center",ctx.textBaseline="middle",a=0;a<pulses.length;++a)c=Math.round(127*(1-pulses[a].phase)).toString(16),1===c.length&&(c="0"+c),ctx.beginPath(),ctx.lineWidth=4,ctx.strokeStyle="#"+c+c+c,ctx.arc(pulses[a].x,pulses[a].y,200*pulses[a].phase,0,2*Math.PI),ctx.stroke(),ctx.closePath();for(a=0;a<players.length;++a)for(e=players[a],ctx.beginPath(),ctx.arc(e.x,e.y,e.size,0,2*Math.PI),e.id===activePlayer&&freeze===FREEZE_STATES.WAIT_PUNISH?(ctx.fillStyle="#220000",ctx.strokeStyle="#bb1111"):(ctx.fillStyle="#000022",ctx.strokeStyle="#1111bb"),e.id===activePlayer?(ctx.fill(),ctx.lineWidth=2):ctx.lineWidth=1,ctx.stroke(),ctx.closePath(),0!==e.id&&(ctx.fillStyle=e.id===activePlayer&&freeze===FREEZE_STATES.WAIT_PUNISH?"#bb1111":"#1111bb",ctx.font="30px Arial",ctx.fillText(e.id,e.x,e.y)),b=0;b<e.fingers.length;++b)d=e.fingers[b],ctx.save(),ctx.translate(d.x,d.y),ctx.rotate(d.rotation),ctx.beginPath(),ctx.rect(-10,-15,20,30),e.id===activePlayer&&freeze===FREEZE_STATES.WAIT_PUNISH?(ctx.fillStyle="#220000",ctx.strokeStyle="#bb1111"):(ctx.fillStyle="#002200",ctx.strokeStyle="#11bb11"),d.active?(ctx.fill(),ctx.lineWidth=3):ctx.lineWidth=1,ctx.stroke(),ctx.closePath(),0!==d.id&&(ctx.fillStyle=e.id===activePlayer&&freeze===FREEZE_STATES.WAIT_PUNISH?"#bb1111":"#11bb11",ctx.font="15px Arial",ctx.fillText(d.id,0,0)),ctx.restore();window.requestAnimationFrame(render)}function parseFrame(a){"use strict";var b,c,d,e,f,g,h,i,j,k,l,m;for(l=[],k={},b=0;b<a.hands.length;++b)if(h=a.hands[b],m=void 0,gameState!==GAME_STATES.SEARCH_PLAYERS||leapPlayerMap[h.id]||5!==h.fingers.length?leapPlayerMap[h.id]&&(m=leapPlayerMap[h.id]):(say("Player detected."),m=new Player),m){for(m.x=h.palmPosition[0],m.y=h.palmPosition[2],m.size=h.sphereRadius/2,l.push(m),k[h.id]=m,j=[],i={},e=!1,f=0,c=0;c<h.fingers.length;++c)g=h.fingers[c],m.leapFingerMap[g.id]?d=m.leapFingerMap[g.id]:(d=new Finger,e=!0),d.x=g.tipPosition[0],d.y=g.tipPosition[2],d.rotation=g.direction[0],f+=g.tipPosition[1]/h.fingers.length,j.push(d),i[g.id]=d;if(h.fingers.length>=3)for(c=0;c<h.fingers.length;++c)g=h.fingers[c],d=i[g.id],d.active&&f-g.tipPosition[1]<12&&(d.active=!1),!d.active&&f-g.tipPosition[1]>17&&(d.active=!0);m.fingers.length!==j.length&&(e=!0),m.fingers=j,m.leapFingerMap=i,e&&5===m.fingers.length&&m.enumerateFingers()}players=l,leapPlayerMap=k}function keyPress(a){"use strict";var b;if(a.preventDefault(),32===a.keyCode){if(gameState===GAME_STATES.SEARCH_PLAYERS&&players.length>0){for(say("Let's begin!"),enumerateObjects(players),totalPlayers=players.length,nonDeadPlayers=[],b=0;b<players.length;++b)nonDeadPlayers.push(players[b].id);gameState=GAME_STATES.PLAY}freeze===FREEZE_STATES.WAIT_PUNISH&&(say("Player "+activePlayer+", let's try again!"),freeze=FREEZE_STATES.WAIT_SPEECH,window.setTimeout(function(){currentFingers={},currentSequence=[],freeze=FREEZE_STATES.NONE},400))}}function logic(){"use strict";var a,b,c,d,e,f;if(!freeze&&gameState===GAME_STATES.PLAY&&players.length>0&&(!activePlayer||currentSequence.length>storedSequence.length&&checkSequence())){for(storedSequence=currentSequence,currentSequence=[],activePlayer=activePlayer?1+activePlayer%totalPlayers:1;!getPlayer(activePlayer);)activePlayer=1+activePlayer%totalPlayers;currentFingers={},freeze=FREEZE_STATES.WAIT_SPEECH,window.setTimeout(function(){say("Player "+activePlayer+", it's your turn!"),window.setTimeout(function(){freeze=FREEZE_STATES.NONE},200)},400)}if(!freeze&&gameState===GAME_STATES.PLAY&&(f=getPlayer(activePlayer))){for(c={},a=0;a<f.fingers.length;++a)b=f.fingers[a],0!==b.id&&(b.active?(c[b.id]=!0,currentFingers[b.id]||0!==currentSequence.length&&currentSequence[currentSequence.length-1]===b.id||(currentSequence.push(b.id),pulses.push(new Pulse(b.x,b.y)),console.log("Play "+b.id),synths[b.id].play())):synths[b.id].pause());if(currentFingers=c,!checkSequence()){for(say("Player "+activePlayer+", you are wrong! Game members, feel free to punish him! Press space when you are ready!"),synths.fail.play(),window.setTimeout(function(){synths.fail.pause()},1e3),a=1;5>=a;++a)synths[a].pause();freeze=FREEZE_STATES.WAIT_PUNISH}}if(!freeze&&gameState===GAME_STATES.PLAY){for(d=[],a=0;a<nonDeadPlayers.length;++a)getPlayer(nonDeadPlayers[a])||freeze===FREEZE_STATES.WAIT_SPEECH?d.push(nonDeadPlayers[a]):(say("We lost player "+nonDeadPlayers[a]+"!"),freeze=FREEZE_STATES.WAIT_SPEECH,window.setTimeout(unfreez,1e3));nonDeadPlayers=d}for(freeze||gameState!==GAME_STATES.PLAY||0!==players.length||(say("You are drunk. The game ends now!"),activePlayer=void 0,gameState=GAME_STATES.END),e=[],a=0;a<pulses.length;++a)pulses[a].phase+=.04,pulses[a].phase<1&&e.push(pulses[a]);pulses=e,window.setTimeout(logic,50)}function init(){"use strict";var a;for(gameState=GAME_STATES.BOOT,canvas=document.getElementById("canvas"),canvas.height=canvas.clientHeight,canvas.width=canvas.clientWidth,ctx=canvas.getContext("2d"),leap=new Leap.Controller,leap.on("frame",parseFrame),leap.connect(),meSpeak.loadConfig("data/mespeak_config.json"),meSpeak.loadVoice("data/mespeak_en.json"),a=1;5>=a;++a)flock.init(),synths[a]=flock.synth({synthDef:[{id:"leftSynth_"+a,ugen:"flock.ugen.triOsc",freq:FREQUENCIES[a]},{id:"rightSynth_"+a,ugen:"flock.ugen.triOsc",freq:FREQUENCIES[a]+2}]});flock.init(),synths.fail=flock.synth({synthDef:{ugen:"flock.ugen.lfPulse",freq:1e3,mul:.1}}),document.addEventListener("keydown",keyPress),gameState=GAME_STATES.SEARCH_PLAYERS,window.requestAnimationFrame(render),window.setTimeout(logic,50),say("Welcome, my name is Aurora. I'm your brainmaster. Just put your 5 finger hands over the leap device and press space when all players are detected.")}var canvas,ctx,leap,leapPlayerMap={},gameState,freeze=!1,players=[],nonDeadPlayers,totalPlayers,activePlayer,storedSequence=[],currentSequence=[],currentFingers={},pulses=[],synths=[],GAME_STATES={BOOT:0,SEARCH_PLAYERS:1,PLAY:2,END:3},FREEZE_STATES={NONE:!1,WAIT_PUNISH:1,WAIT_SPEECH:2},FREQUENCIES={1:261.6,2:293.7,3:329.6,4:349.2,5:415.3};window.onload=init;
/*
//@ sourceMappingURL=js/main.sourcemap.js
*/